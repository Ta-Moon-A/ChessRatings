<!DOCTYPE html>

<html>

<head>
    <meta charset="UTF-8">
    <title>Chart</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">




</head>

<body translate="no">

    <div class="container centered">
        <div id="myGraph"></div>
    </div>
    <script src="libs/d3.v4.min.js"></script>
    <script src="scripts/d3script.js"></script>
    <script src="scripts/tooltip.js"></script>
    <script src="scripts/processdata.js"></script>

    <script>
        var ratingCategories = [{ name: "bulletrating", desc: "BULLET" },
                                { name: "blitzrating", desc: "BLITZ" },
                                { name: "classicalrating", desc: "CLASSICAL" }];

        
        var units = ["internal", "qc", "digital", "core"];


        data.ratingCategories = ratingCategories;
        data.units = units;


        // d3.xhr("https://lichess.org/api/users")
        //     .header("Content-Type", "application/json")
        //     .post( Object.keys(data.users).join(), function (err, rawData) {


        //     });

        // d3.request("https://lichess.org/api/users").send("GET",  `"${Object.keys(data.users).join()}"`, function(err, rawData)
        // {
        //     debugger;
        //       var result = JSON.parse(rawData);


        // });

        //--------------------------- make queue for lichess calls ---------------------------
        var queue = d3.queue();
        Object.keys(data.users).forEach(username => {
            queue.defer(d3.json, "https://lichess.org/api/user/" + username)
        })

        queue.awaitAll(ready);

        function ready(err, result) {

            data.result = result.map(function (d) {
                return {
                    id: d.id,
                    isOnline: d.online,
                    username: d.username,
                    blitzrating: d.perfs.blitz.rating,
                    bulletrating: d.perfs.bullet.rating,
                    classicalrating: d.perfs.classical.rating,
                    fullname: data.users[d.username].fullname,
                    unit: data.users[d.username].unit
                }
            });

            // console.log("result  ");
            // console.log(data.result);

            var chart = renderChart()
                .svgHeight(window.innerHeight - 30)
                .svgWidth(window.innerWidth - 30)
                .container('#myGraph')
                .data(data)
                .debug(true)
                .run()

        }
        
    </script>


</body>

</html>